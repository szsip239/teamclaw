#!/bin/sh

# ============================================================
# Pre-commit guard: block private files and secrets
# ============================================================

STAGED=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED" ]; then
  exit 0
fi

ERROR=0

# --- 1. Block private files ---
# Allowlist: files that look like they match but are safe to commit
ALLOWED_FILES=".env.example"

is_allowed() {
  for allowed in $ALLOWED_FILES; do
    if [ "$1" = "$allowed" ]; then
      return 0
    fi
  done
  return 1
}

PRIVATE_PATTERNS="
CLAUDE.md
.claude/
PRD.md
DEVELOPMENT.md
docs/PRD.md
docs/DEVELOPMENT.md
scripts/debug-
.env
.env.local
.env.*.local
openclaw*.md
"

for pattern in $PRIVATE_PATTERNS; do
  MATCHED=$(echo "$STAGED" | grep -F "$pattern" || true)
  if [ -n "$MATCHED" ]; then
    for file in $MATCHED; do
      if is_allowed "$file"; then
        continue
      fi
      echo "❌ BLOCKED: private file staged for commit:"
      echo "   $file"
      echo "   This file is for local development only and must not be pushed."
      echo ""
      ERROR=1
    done
  fi
done

# --- 2. Scan for hardcoded secrets ---
SECRETS_REGEX='(PRIVATE_KEY|SECRET_KEY|ENCRYPTION_KEY|API_KEY|sk-[a-zA-Z0-9]{20,}|-----BEGIN\s*(RSA\s*)?PRIVATE\s*KEY)'

for file in $STAGED; do
  # Skip the hook file itself to avoid self-detection
  case "$file" in .husky/*) continue ;; esac
  if [ -f "$file" ]; then
    MATCH=$(git diff --cached -- "$file" | grep -E "^\+" | grep -iE "$SECRETS_REGEX" | head -3 || true)
    if [ -n "$MATCH" ]; then
      echo "❌ BLOCKED: possible secret in $file:"
      echo "$MATCH" | head -3
      echo ""
      ERROR=1
    fi
  fi
done

# --- 3. Check for hardcoded Chinese in components (i18n rule) ---
for file in $STAGED; do
  case "$file" in
    src/components/*|src/app/*)
      if [ -f "$file" ]; then
        CHINESE=$(git diff --cached -- "$file" | grep -E "^\+" | grep '[一-鿿]' | grep -v "// " | grep -v "import " | head -3 || true)
        if [ -n "$CHINESE" ]; then
          echo "⚠️  WARNING: hardcoded Chinese text in $file:"
          echo "$CHINESE" | head -3
          echo "   Use t('key') from useT() instead."
          echo ""
          ERROR=1
        fi
      fi
      ;;
  esac
done

if [ $ERROR -ne 0 ]; then
  echo "==========================================="
  echo "Commit blocked. Fix the issues above."
  echo "If intentional, use: git commit --no-verify"
  echo "==========================================="
  exit 1
fi
